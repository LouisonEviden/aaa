name: Setup Snowflake environment
run-name: Setup Snowflake environment triggered by @${{ github.actor }}
on:
    push:
      branches:
        - main
    workflow_dispatch:
jobs:
    setup-dbt:
        name: Update DBT project files
        runs-on: ubuntu-latest
        permissions:
            contents: write
            pull-requests: write
        steps:
            - uses: actions/checkout@v4
            - uses: cardinalby/export-env-action@v2
              with:
                envFile: '.github/.env'
            - name: Update dbt_project.yml
              run: yq -i 'with(. ; .profile = env(PROJECT_NAME) | .name = env(PROJECT_NAME))' dbt_project.yml
            - run: cat dbt_project.yml
            - name: Update profiles.yml
              run: |
                yq -i '(.template_profile_name | key) = env(PROJECT_NAME)' profiles.yml
                yq -i 'with(.[env(PROJECT_NAME)].outputs[]; .account = env(SNOWFLAKE_ACCOUNT) | .database = env(SNOWFLAKE_DATABASE) | .role = env(SNOWFLAKE_ROLE) | .user = env(SNOWFLAKE_USER) | .warehouse = env(SNOWFLAKE_WAREHOUSE))' profiles.yml
            - run: cat profiles.yml
            - name: Update models/schema.yml
              run: yq -i 'with(.sources.[]; .database = env(SNOWFLAKE_DATABASE))' models/schema.yml
            - run: cat models/schema.yml
            - name: Create Pull Request
              uses: peter-evans/create-pull-request@v7
              with:
                token: ${{ secrets.GITHUB_TOKEN }}
                commit-message: Set up DBT
                branch: github_action/DBT_setup
                title: DBT config set up

    setup-snowflake:
        name: Setup Snowflake
        runs-on: ubuntu-latest
        steps:
            - uses: actions/checkout@v4
            - uses: cardinalby/export-env-action@v2
              with:
                envFile: '.github/.env'
            - run: echo ${{ env.PROJECT_NAME }}
        # Check if user is account admin ?
        # Create database, schema, roles
        # Assign roles to schema/db